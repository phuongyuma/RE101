## ANALYSIS REPORT

Analyze a malware (WannaCry) behaviors in both static and dynamic way. 
Because this is the first time i analysis malware so i will note a few things worth noting for the analysis.

------
Table of content
1. [Set up enviroment](#Set%20up%20enviroment)
2. [General description of WannaCry](#General%20description%20of%20WannaCry)
3. [Static analysis](#Static%20analysis)
4. [Dynamic analysis](#Dynamic%20analysis)
5. [Reference](#Reference)
-------
### Set up enviroment

We need an safe virtualized environment for malware analysis.
Here are some general guidelines to follow when setting up a malware analysis environment:
1. Isolation: It is essential to keep the malware isolated from the rest of your network and systems. This can be achieved by using a separate, dedicated analysis machine or virtual environment.
2. Sandboxing: Use a sandboxed environment in which the malware can be safely executed. This can be a physical or virtualized environment that is isolated from the rest of your network.
3. Monitoring: Use monitoring tools, such as a network sniffer or host-based intrusion detection system, to capture and analyze network traffic, system calls, and other activity to observe the malware's behavior.
4. Backups: Make sure you have current backups of your systems and data before you begin your analysis. This will allow you to restore your systems to a known good state if the malware causes damage or if you need to revert changes made during the analysis.
5. Security controls: Ensure that your security controls, such as firewalls and intrusion detection/prevention systems, are in place and configured to block any suspicious activity or network traffic.
6. Access controls: Limit the number of people who have access to the analysis environment and monitor all access to the environment.
7. Disposal : Proper disposal of the malware samples and all associated files after the analysis is done.
8. Document : Keep a detailed and accurate record of all steps taken during the analysis, including the software and tools used, the results of the analysis, and any remediation steps taken.

I use **FLARE VM** on **VMware** and set NIC of this virtual machine to **host-only**, and disconnect it when I am executing the malware. (Since this is my first exposure to malware, I will try to do it carefully)

Before do something with malware, I take a snapshot of the machine to backups.

---
### General description of WannaCry

The first appearance of malware WannaCry was May 2017. Some affected systems have national importance. CTU® researchers link the rapid spread of the ransomware to use of a separate worm component that exploited vulnerabilities in the Windows Server Message Block (SMB) v1 protocol. Microsoft addressed the SMBv1 vulnerabilities in March 2017 with Security Bulletin MS17-010.

WannaCry (WCry, WannaCryptor) is [ransomeware malware](https://en.wikipedia.org/wiki/Ransomware). With the EnternalBlue exploit, it has the ability to spread through the network. The malware begins its malicious activity by checking for a hardcoded [kill switch](https://www.techtarget.com/whatis/definition/kill-switch) domain - either fferfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com or iuqerfsodp9ifjaposdfjhgosurijfaewrwergwea[.]com.  If the connection is successful, it stops running and exits.  If the connection isn't successful, the ransomware encrypts files on the machine, following which an attempt to exploit the SMB vulnerability takes place. After encryption is completed, a ransom note is displayed to the user and the attackers demand $300 to be paid in a 3-day timespan. If the victim resists the ransom amount rises to $600 to be paid in 7 days. The payments are directed to multiple hardcoded bitcoin addresses.

---
### Static Analysis

Analyze the malware without executing it. This can be done by examining the code, data, and resources in the sample to see if it contains any obvious indicators of malicious behavior

Steps:
1.  File analysis: Analyze the file properties, such as the file size, the file type, the file name, and the file creation and modification dates.
2.  File header analysis: Analyze the file header of the malware to identify the file format and possible packer used.
3.  Signature-based detection: Compare the code or data structure with known malware samples using signature-based detection tools such as VirusTotal, Hybrid-Analysis, etc.
4.  File unpacking: Unpack the malware sample if it is packed or obfuscated, which can be done by using tools such as UPX, Themida, or other unpacker.
5.  File disassembly: Disassemble the malware sample using a disassembler such as IDA Pro, Ghidra, etc. to see the assembly code.
6.  File Decompilation: Decompile the malware sample using a Decompiler such as Hex-Rays, RetDec, etc. to see the source code.
7.  Strings analysis: Extract and analyze the strings in the malware sample. This can reveal information such as file paths, IP addresses, and other data that may be useful in understanding the malware's behavior.
8.  Dependency analysis: Use a tool such as Dependency Walker to analyze the dependencies of the malware. This can help you understand which other libraries or DLLs are required by the malware.

CFF Explorer is a tool that allows you to view and edit the structure and content of PE files, including the headers, sections, resources, and import/export tables.

Use `CFF Explorer` to get an overview about this file like: file type, hash, file size, libary, function import, PE header
![](IMG/Pasted%20image%2020230113170525.png)

![](IMG/Pasted%20image%2020230113170650.png)

Use `CyberChef` or `HashCalc` to find hashing of malware. We can search the hashing in `VirusTotal` to see if the file has already been identified.
![](IMG/Pasted%20image%2020230113170951.png)
![](IMG/Pasted%20image%2020230116050805.png)
MD5 hash of this malware sample is `84c82835a5d21bbcf75a61706d8ab549`

`Detect it easy` can be used to extract information such as the file properties, imports, exports, and other data that can be used to identify the malware and its behavior. The tool can also be used to detect packers and crypters
![](IMG/Pasted%20image%2020230113171236.png)

We can see section **.rdata** and **.rsrc** has been packed
![](IMG/Pasted%20image%2020230113171251.png)

We can use `DIE` to find some **Strings** useful. 
![](IMG/Pasted%20image%2020230116161329.png)
Example that with this, we find some function that the malware have used to encrypt our files. WannaCry use RSA and AES encryption algorithm. The encryption process is very strong and makes the files inaccessible to the user, and it's extremely difficult to recover the files without the decryption key. 
![](IMG/Pasted%20image%2020230113171631.png)
Signature data:
`WANACRY!` , `WanaCrypt0r` , `WNcry@2ol7`
COMMAND RELATED STRINGS
`cmd.exe /c “%s”`
`icacls . /grant Everyone:F /T /C /Q `
`attrib +h .``
Executable file
`taskdl.exe`, `taskse.exe`, `tasksche.exe`
File extensions will be encrypt?
![](IMG/Pasted%20image%2020230116161147.png)

Use plugin KANAL of tool `PeID`  to  to detect signatures for cryptographic operations on the executable file.
![](IMG/Pasted%20image%2020230116163004.png)


---

### Dynamic Analysis


Steps:
1.  Prepare the analysis environment: Set up a controlled environment such as a sandbox or a virtual machine where you can safely execute the malware without it affecting the host system.
2.  Monitor the system: Use tools such as Procmon, Sysinternals Suite, or other monitoring tools to capture the system activity and the malware's behavior during execution.
3.  Capture network traffic: Use tools such as Wireshark or other packet sniffers to capture the network traffic generated by the malware.
4.  Isolate the malware: Use tools such as Sandboxie, or other isolation tools to isolate the malware from the host system and limit its ability to access the network or the file system.
5.  Monitor the registry: Use tools such as Regshot or other registry monitoring tools to capture the registry changes made by the malware.
6.  Monitor the memory: Use tools such as Volatility or other memory analysis tools to capture the memory dump of the malware's process and analyze its behavior.
7.  Run dynamic analysis tools: Use dynamic analysis tools such as Cuckoo Sandbox, Joe Sandbox, etc. to automatically analyze the malware behavior and provide a detailed report.
8.  Analyze the results: Use the results obtained from the monitoring tools and dynamic analysis tools to analyze the malware's behavior, such as its persistence mechanisms, network communication, and evasion techniques.


Workflow when using tools:
Step 1: Disconnect the machine from the Internet: set NIC to “host-only”, disable folder-sharing.
Step 2: Start Procmon, then pause, and clear. Start FakeNet. Start Regshot and take shot 1.
Step 3: Resume Procmon and run malware until 3 mins, we can see malware note.
Step 4: Pause Procmon and save file Procmon as PML and CSV.
Step 5: Use Regshot to take shot 2. Compare shot 1 and shot 2. Save the output.

After five steps, we have 4 files: file .pcap from FakeNet logs, 2 file Procmon and file result the comparison of Reshot.

When run file .exe, malware encrypt file in the folder to [file-name].wnry
![](IMG/Pasted%20image%2020230116025938.png)

After it encrypt done, a progarm name Wana Decrypt 2.0 will display.
![](IMG/Pasted%20image%2020230116030025.png)


The result comparision of `Regshot` before and after run malware.
![](IMG/Pasted%20image%2020230116030300.png)
Details of the comparion
![](IMG/Pasted%20image%2020230116054240.png)
We use `Procmon` to capture the system activity and the malware's behavior during execution.
![](IMG/Pasted%20image%2020230116030333.png)

Process Tree:
![](IMG/Pasted%20image%2020230116030409.png)

Use **Filter** to analyze the file easily.
![](IMG/Pasted%20image%2020230116030533.png)

We use `FakeNet` to spoofing a network and capture the network traffic generated by the malware. The result saved at file .pcap
In the photo below. 
![](IMG/Pasted%20image%2020230116030626.png)
![[Pasted image 20230116051924.png]]


---

### Reference

Book: Pratical Malware Analysis
https://any.run/malware-trends/wannacry
https://www.secureworks.com/research/wcry-ransomware-analysis
https://blog.kartone.ninja/2019/05/23/malware-analysis-a-wannacry-sample-found-in-the-wild/
https://logrhythm.com/blog/a-technical-analysis-of-wannacry-ransomware/
[Malware Analysis Bootcamp - Setting Up Our Environment](https://www.youtube.com/watch?v=F1LE56QQ7iA)
https://cyberstruggle.org/2018/10/15/wannacry-dropper-analysis/
[Ransomeware analysis: 1 - WannaCry](https://www.youtube.com/watch?v=Qh1LAbzzfBs)

